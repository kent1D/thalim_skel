[(#REM)
/**
 * Plugin Agenda 4 pour Spip 3.0
 * Licence GPL 3
 *
 * 2006-2011
 * Auteurs : cf paquet.xml
 */
]
<section id="sommaire_actualites" class="offset1 span6">
    <script>
       $(window).on('load', function() {
            $(".toggle-img").hide();
            $(".padding span").css('text-align', 'center');
            //setHeights();
            $(window).resize(function(event) {
                event.stopPropagation();
                //setHeights();
            });
            $(".wrapper.sommaire").mouseenter(function(event) {
                event.stopPropagation();
                $(this).children(".toggle-img").fadeToggle();
            }).mouseleave(function(event) {
                event.stopPropagation();
                $(this).children(".toggle-img").fadeToggle();
            })
            $(".toggle-img div.soixante").height(function() {
                var hght = $(this).parent().height() - ($(this).siblings('div').first().height() * 2);
                if (hght < 50) {
                    $(this).css("white-space", "nowrap");
                } else if (hght < 80 && $(this).text().length > 20) {
                    $(this).siblings('div.vingt').first().show();
                    $(this).hide();
                } else {
                    $(this).siblings('div.vingt').first().hide();
                }
            });

/*            function setHeights() {
                $("#sommaire_actualites").find("img").width(function() {
                    $(this).height('auto');
                    return $(this).closest(".element").width();
                });
                var maxHeight = Math.max.apply(null, $("#sommaire_actualites").find("img").map(function () {
                            return $(this).height();
                        }).get());
                $("article").height(maxHeight);

                var widthNoImg = maxHeight * .707070;
                $("article.sommaire-no-img").width(widthNoImg);
                $(".no-img .padding span").height(function() {
                    return maxHeight - ($(this).siblings('p').first().height() * 2);
                });
            }*/
        });
    </script>
	<header>
		<h1 class="ellipse #EDIT{meta-agenda/titre}"><div class="ovale"> </div><span class="titre">[(#CONFIG{agenda/titre}|sinon{<:agenda:titre_sur_l_agenda:>}|typo)]</span></h1>
	</header>
	#SET{affichage_duree,#ENV{affichage_duree,#CONFIG{agenda/affichage_duree,12}}}
	#SET{affichage_debut,#CONFIG{agenda/affichage_debut,#ENV{affichage_debut,date_jour}}}
    #SET{date_debut,#ENV{date_debut,#ENV{date}}|affdate{'Y-m-d 00:00:00'}}
    [(#REM) #SET{date_fin,#GET{date_debut}|agenda_moisdecal{#GET{affichage_duree},'Y-m-01 23:59:59'}|agenda_dateplus{-86400}}]
    #SET{date_debut_ouv,#ENV{date}|affdate{'Y-m-01 H:i:00'}|agenda_date_debut_liste{#GET{affichage_debut}}}
    #SET{date_fin,#GET{date_debut}|agenda_moisdecal{#GET{affichage_duree},'Y-m-d 00:00:00'}}
 	#SET{exposition,#ARRAY}
    <BOUCLE_ev_expo(EVENEMENTS){id_rubrique=271}{!evenement_passe #GET{date_debut}}{!evenement_a_venir #GET{date_fin}}{par date_debut}{id_article?}{id_rubrique?}{id_mot?}{id_evenement_source?}>
        <BOUCLE_ev_expo2(ARTICLES){auteurs.statut IN 0minirezo,1comite}{id_evenement=#ID_EVENEMENT}{id_mot=220}{doublons #ID_EVENEMENT}>
    	   [(#SET{cle,[(#DATE_DEBUT|replace{-,''}|replace{:,''}|replace{' ',''})_evenement_#ID_EVENEMENT]})]
           [(#SET{exposition,[(#GET{exposition}|array_merge{[(#ARRAY{#GET{cle},#ID_EVENEMENT})]})]})]
	    </BOUCLE_ev_expo2>
    </BOUCLE_ev_expo>

	#SET{prix,#ARRAY}
    <BOUCLE_ev_prix(EVENEMENTS){id_rubrique=271}{!evenement_passe #GET{date_debut}}{!evenement_a_venir #GET{date_fin}}{par date_debut}{id_article?}{id_rubrique?}{id_mot?}{id_evenement_source?}>
        <BOUCLE_ev_prix2(ARTICLES){auteurs.statut IN 0minirezo,1comite}{id_evenement=#ID_EVENEMENT}{id_mot=1050}{doublons #ID_EVENEMENT}>
			[(#SET{cle,[(#DATE_DEBUT|replace{-,''}|replace{:,''}|replace{' ',''})_evenement_#ID_EVENEMENT]})]
			[(#SET{prix,[(#GET{prix}|array_merge{[(#ARRAY{#GET{cle},#ID_EVENEMENT})]})]})]
		</BOUCLE_ev_prix2>
	</BOUCLE_ev_prix>

    [(#REM) retrive COLLOQUES]
    #SET{colloques, #ARRAY}
    <B_ev_colloque>
        <BOUCLE_ev_colloque(EVENEMENTS){id_rubrique=250}{!evenement_passe #GET{date_debut}}{!evenement_a_venir #GET{date_fin}}{par date_debut}{id_article?}{id_rubrique?}{id_mot?}{id_evenement_source?}>
            <BOUCLE_ev_colloque_thalim(ARTICLES){auteurs.statut IN 0minirezo,1comite}{id_evenement=#ID_EVENEMENT}>
                [(#SET{cle,[(#DATE_DEBUT|!={'0000-00-00 00:00:00'}|?{#DATE_DEBUT,#DATE_ECRITURE}|replace{-,''}|replace{:,''}|replace{' ',''})_colloque_#ID_ARTICLE]})]
		        [(#SET{colloques,[(#GET{colloques}|array_merge{[(#ARRAY{#GET{cle},[(#INCLURE{fond=inclure/resume/evenement_sommaire,id_evenement,sans_document=non,intro=non,env})]})]})]})]
            </BOUCLE_ev_colloque_thalim>
        </BOUCLE_ev_colloque>
        #SET{has_event,oui}
    </B_ev_colloque>

    [(#REM) retrieve APPELS]
	#SET{appels,#ARRAY}
	<BOUCLE_rubriques3(RUBRIQUES){id_rubrique=262}>
		[(#REM)Les appels qui commencent dans ce qui reste de mois]
		<BOUCLE_ev3_1(ARTICLES){auteurs.statut IN 0minirezo,1comite}{date > #ENV{date}}{date > #GET{date_debut}}{date < #GET{date_fin}}{id_mot?}{id_rubrique}{doublons}>
			[(#SET{appels,[(#GET{appels}|array_merge{[(#ARRAY{[(#DATE|replace{' ','_'}|replace{':','_'})]_[(#COMPTEUR_BOUCLE)],#ID_ARTICLE})]})]})]
		</BOUCLE_ev3_1>
		<BOUCLE_ev3_2(ARTICLES){auteurs.statut IN 0minirezo,1comite}{date_redac != ''}{date_redac != '0000-00-00 00:00'}{date_redac < #ENV{date}}{date > #ENV{date}}{id_mot?}{id_rubrique}{doublons}>
			[(#SET{appels,[(#GET{appels}|array_merge{[(#ARRAY{[(#DATE_REDAC|replace{' ','_'}|replace{':','_'})]_[(#COMPTEUR_BOUCLE)],#ID_ARTICLE})]})]})]
		</BOUCLE_ev3_2>
		<BOUCLE_ev3_21(ARTICLES){auteurs.statut IN 0minirezo,1comite}{date_redac != ''}{date_redac != '0000-00-00 00:00'}{date_redac >= #ENV{date}}{date_redac < #GET{date_fin}}{date > #GET{date_fin}}{id_mot?}{id_rubrique}{doublons}>
			[(#SET{appels,[(#GET{appels}|array_merge{[(#ARRAY{[(#DATE_REDAC|replace{' ','_'}|replace{':','_'})]_[(#COMPTEUR_BOUCLE)],#ID_ARTICLE})]})]})]
		</BOUCLE_ev3_21>
	</BOUCLE_rubriques3>

	#SET{publications_ouvrages,#ARRAY}
	#SET{mots_ouvrages,#LISTE{463,1053}}
	#SET{type_hal_ouvrages,#LISTE{OUV,DOUV}}
	<BOUCLE_ev1(HALS_PUBLICATIONS){date_production >= #GET{date_debut_ouv}}{date_production < #GET{date_fin}}{typdoc IN #GET{type_hal_ouvrages}}{date_production != 0000-00-00 00:00:00}{!par date_production}{doublons hal_ouvrages}>
		<BOUCLE_aut_ev1(AUTEURS){statut IN 0minirezo,1comite}{id_objet = #ID_HAL}{objet=hal}{par nom}{0,1}>
		    [(#SET{cle,[(#DATE_PRODUCTION|!={'0000-00-00 00:00:00'}|?{#DATE_PRODUCTION,#DATE_ECRITURE}|replace{-,''}|replace{:,''}|replace{' ',''})_hal_#ID_HALS_PUBLICATION]})]
		    [(#SET{publications_ouvrages,[(#GET{publications_ouvrages}|array_merge{[(#ARRAY{#GET{cle},[(#INCLURE{fond=inclure/resume/publication_hal_sommaire,id_hals_publication,intro=non,env})]})]})]})]
		</BOUCLE_aut_ev1>
	</BOUCLE_ev1>
	<BOUCLE_ev2(HALS_PUBLICATIONS){date_production >= #GET{date_debut_ouv}}{date_production < #GET{date_fin}}{typdoc IN #GET{type_hal_ouvrages}}{date_production = 0000-00-00 00:00:00}{!par date_production}{doublons hal_ouvrages}>
		<BOUCLE_aut_ev2(AUTEURS){statut IN 0minirezo,1comite}{id_objet = #ID_HAL}{objet=hal}{par nom}{0,1}>
	    	[(#SET{cle,[(#DATE_PRODUCTION|!={'0000-00-00 00:00:00'}|?{#DATE_PRODUCTION,#DATE_ECRITURE}|replace{-,''}|replace{:,''}|replace{' ',''})_hal_#ID_HALS_PUBLICATION]})]
	    	[(#SET{publications_ouvrages,[(#GET{publications_ouvrages}|array_merge{[(#ARRAY{#GET{cle},[(#INCLURE{fond=inclure/resume/publication_hal_sommaire,id_hals_publication,intro=non,env})]})]})]})]
		</BOUCLE_aut_ev2>
	</BOUCLE_ev2>
	<BOUCLE_rubriques_pub(RUBRIQUES){racine}{composition=publications}>
		<BOUCLE_ouvrages_pub(ARTICLES){auteurs.statut IN 0minirezo,1comite}{branche}{id_mot IN #GET{mots_ouvrages}}{date >= #GET{date_debut_ouv}}{date < #GET{date_fin}}>
			[(#SET{cle,[(#DATE|replace{-,''}|replace{:,''}|replace{' ',''})_article_#ID_ARTICLE]})]
			[(#SET{publications_ouvrages,[(#GET{publications_ouvrages}|array_merge{[(#ARRAY{[(#GET{cle})],[(#INCLURE{fond=inclure/resume/publication_sommaire,id_article,intro=non,env})]})]})]})]
		</BOUCLE_ouvrages_pub>
	</BOUCLE_rubriques_pub>

    #SET{sout,#ARRAY}
    <BOUCLE_annee4(RUBRIQUES){id_rubrique=270}>
        <B_ev_soutenance>
        <BOUCLE_ev_soutenance(EVENEMENTS){id_rubrique=#ID_RUBRIQUE}{!evenement_passe #GET{date_debut}}{!evenement_a_venir #GET{date_fin}}{par date_debut}{id_article?}{id_rubrique?}{id_mot?}{id_evenement_source?}>
            [(#SET{cle,[(#DATE_DEBUT|!={'0000-00-00 00:00:00'}|?{#DATE_DEBUT,#DATE_ECRITURE}|replace{-,''}|replace{:,''}|replace{' ',''})_EVT_#ID_EVENEMENT]})]
            [(#SET{sout,[(#GET{sout}|array_merge{[(#ARRAY{#GET{cle},#ID_EVENEMENT})]})]})]
        </BOUCLE_ev_soutenance>
        #SET{has_event,oui}
        </B_ev_soutenance>
    </BOUCLE_annee4>

    #SET{evts,#ARRAY}
	<BOUCLE_rubriques2(RUBRIQUES){id_rubrique IN 247,271,267}>
        <BOUCLE_ev(EVENEMENTS){!evenement_passe #GET{date_debut}}{!evenement_passe #GET{date_debut}}{!evenement_a_venir #GET{date_fin}}{par id_rubrique, date_debut}{id_article?}{id_mot?}{id_evenement_source?}{id_rubrique}>
            <BOUCLE_ev_autre(ARTICLES){auteurs.statut IN 0minirezo,1comite}{id_evenement=#ID_EVENEMENT}{doublons #ID_EVENEMENT}>
            [(#SET{cle,[(#DATE_DEBUT|replace{-,''}|replace{:,''}|replace{' ',''})_evenement_#ID_EVENEMENT]})]
            [(#SET{evts,[(#GET{evts}|array_merge{[(#ARRAY{#GET{cle},#ID_EVENEMENT})]})]})]
            </BOUCLE_ev_autre>
        </BOUCLE_ev>
	</BOUCLE_rubriques2>


    [(#REM)
        AFFICHE
    ]
    #SET{cmpt,0}
    <B_display>
    <div class="flex-container-sommaire">
    <BOUCLE_display(CONDITION){si #VAL{1}|=={1}}>
        [(#REM) affiche EXPOS]
        [(#GET{exposition}|count|>{0}|oui) #SET{expos,ok}]
        <BOUCLE_si_expo(CONDITION){si #GET{expos}|=={ok}|oui}>
            <B_data_expo>
            <BOUCLE_data_expo(DATA){si #GET{exposition}|count|>{0}}{source tableau,#GET{exposition}}{!par cle}>
                <div class="flex-item sommaire align-middle">
                #INCLURE{fond=inclure/resume/evenement_sommaire,id_evenement=#VALEUR,sans_document=non,intro=non,env}
                </div>
            </BOUCLE_data_expo>
            </B_data_expo>
        </BOUCLE_si_expo>


        [(#REM) affiche PRIX]
        [(#GET{prix}|count|>{0}|oui) #SET{prixes,ok}]
        <BOUCLE_si_prix(CONDITION){si #GET{prixes}|=={ok}|oui}>
            <B_data_prix>
            <BOUCLE_data_prix(DATA){si #GET{prix}|count|>{0}}{source tableau,#GET{prix}}{!par cle}>
                <div class="flex-item sommaire align-middle">
                #INCLURE{fond=inclure/resume/evenement_sommaire,id_evenement=#VALEUR,sans_document=non,intro=non,env}
                </div>
            </BOUCLE_data_prix>
            </B_data_prix>
        </BOUCLE_si_prix>


        [(#REM) affiche COLLOQUES]
        [(#GET{colloques}|count|>{0}|oui) #SET{colloq,ok}]
        <BOUCLE_si_colloq(CONDITION){si #GET{colloq}|=={ok}|oui}>
            <B_data_colloq>
            <BOUCLE_data_colloq(DATA){si #GET{colloques}|count|>{0}}{source tableau,#GET{colloques}}{!par cle}>
                <div class="flex-item sommaire align-middle">
                #VALEUR
                </div>
            </BOUCLE_data_colloq>
            </B_data_colloq>
        </BOUCLE_si_colloq>


        [(#REM) affiche APPELS]
        [(#GET{appels}|count|>{0}|oui) #SET{appel,ok}]
        <BOUCLE_si_appel(CONDITION){si #GET{appel}|=={ok}|oui}>
        <B_ev3_3>
        <BOUCLE_ev3_3(DATA){source table,#GET{appels}}{par cle}>
                <div class="flex-item sommaire align-middle">
                #INCLURE{fond=inclure/resume/evenement_date_redac_sommaire,id_article=#VALEUR,sans_document=non,intro=non,env}
                </div>
        </BOUCLE_ev3_3>
        #SET{has_event,oui}
        </B_ev3_3>
        </BOUCLE_si_appel>


        [(#REM) affiche OUVRAGES]
        [(#GET{publications_ouvrages}|count|>{0}|oui) #SET{publications,ok}]
        <BOUCLE_si_publications(CONDITION){si #GET{publications}|=={ok}|oui}>
            <B_data_publications>
            <BOUCLE_data_publications(DATA){si #GET{publications_ouvrages}|count|>{0}}{source tableau,#GET{publications_ouvrages}}{!par cle}>
                <BOUCLE_si_val2(CONDITION){si #VALEUR|?{non,#VALEUR}}>
                    <div class="flex-item sommaire align-middle">
                    #VALEUR
                    </div>
                </BOUCLE_si_val2>
            </BOUCLE_data_publications>
            </B_data_publications>
        </BOUCLE_si_publications>
        #SET{has_event,oui}
        </B_si_publications>


        [(#REM) affiche SOUTENANCES]
        [(#GET{sout}|count|>{0}|oui) #SET{souts,ok}]
        <BOUCLE_si_sout(CONDITION){si #GET{souts}|=={ok}|oui}>
            <B_data_sout>
            <BOUCLE_data_sout(DATA){si #GET{sout}|count|>{0}}{source tableau,#GET{sout}}{!par cle}>
                <div class="flex-item sommaire align-middle">
                [(#INCLURE{fond=inclure/resume/evenement_sommaire,id_evenement=#VALEUR,sans_document=non,intro=non,env})]
                </div>
            </BOUCLE_data_sout>
            </B_data_sout>
        </BOUCLE_si_sout>


        [(#REM) affiche AUTRES EVTS]
        [(#GET{evts}|count|>{0}|oui) #SET{fi_evts,ok}]
        <BOUCLE_si_evts(CONDITION){si #GET{fi_evts}|=={ok}|oui}>
            <B_data_evts>
            <BOUCLE_data_evts(DATA){si #GET{evts}|count|>{0}}{source tableau,#GET{evts}}{par cle}>
                <div class="flex-item sommaire align-middle">
                #INCLURE{fond=inclure/resume/evenement_sommaire,id_evenement=#VALEUR,sans_document=non,intro=non,env}
                </div>
            </BOUCLE_data_evts>
            </B_data_evts>
        </BOUCLE_si_evts>

    </BOUCLE_display>
    <div class="flex-item sommaire empty"></div>
    <div class="flex-item sommaire empty"></div>
    <div class="flex-item sommaire empty"></div>
    </div>
    </B_display>
</section>
